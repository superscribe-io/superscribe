import{_ as s,c as a,o as n,R as o}from"./chunks/framework.70e71619.js";const u=JSON.parse('{"title":"Custom Migrations","description":"A guide on how to setup your owns custom Migrations in Directus.","frontmatter":{"description":"A guide on how to setup your owns custom Migrations in Directus.","readTime":"2 min read"},"headers":[],"relativePath":"extensions/migrations.md","lastUpdated":1682552691000}'),e={name:"extensions/migrations.md"},t=o(`<h1 id="custom-migrations" tabindex="-1">Custom Migrations <a class="header-anchor" href="#custom-migrations" aria-label="Permalink to &quot;Custom Migrations&quot;">​</a></h1><blockquote><p>Directus allows adding custom migration files that run whenever the <code>directus database migrate:*</code> commands are executed. All migrations must reside in the <code>extensions/migrations</code> folder.</p></blockquote><h2 id="file-name" tabindex="-1">File Name <a class="header-anchor" href="#file-name" aria-label="Permalink to &quot;File Name&quot;">​</a></h2><p>The file name follows the following structure:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">[identifier]-[name].js</span></span></code></pre></div><p>for example:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">20201202A-my-custom-migration.js</span></span></code></pre></div><h2 id="structure" tabindex="-1">Structure <a class="header-anchor" href="#structure" aria-label="Permalink to &quot;Structure&quot;">​</a></h2><p>Migrations have to export an <code>up</code> and a <code>down</code> function. These functions get a <a href="http://knexjs.org" target="_blank" rel="noreferrer">Knex</a> instance that can be used to do virtually whatever.</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">module.exports</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#C792EA;">async</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">up</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">knex</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">knex</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">schema</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">createTable</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">test</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">table</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">			</span><span style="color:#A6ACCD;">table</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">increments</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">			</span><span style="color:#A6ACCD;">table</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">string</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">rijk</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">},</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#C792EA;">async</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">down</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">knex</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">knex</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">schema</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">dropTable</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">test</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#89DDFF;">};</span></span></code></pre></div><div class="danger custom-block"><p class="custom-block-title">Danger</p><p>Seeing that these migrations are a bit of a free-for-all, you can really harm your database. Please make sure you know what you&#39;re doing and backup your database before adding these migrations.</p></div><h2 id="migrations-and-directus-schema" tabindex="-1">Migrations and Directus schema <a class="header-anchor" href="#migrations-and-directus-schema" aria-label="Permalink to &quot;Migrations and Directus schema&quot;">​</a></h2><p>Migrations can be used to manage the contents of Directus collections (e.g. initial hydration). In order to do it, you must ensure that the schema is up to date before running your migrations.</p><p><code>directus database migrate:latest</code> runs the required Directus internal migrations and the migrations from <code>migrations</code> directory. In general, you need the following flow:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># Option 1</span></span>
<span class="line"><span style="color:#FFCB6B;">npx</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">directus</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">bootstrap</span></span>
<span class="line"><span style="color:#FFCB6B;">npx</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">directus</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">schema</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">apply</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">./path/to/snapshot.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># Option 2 - without bootstrap, you must ensure that you run all required \`bootstrap\` tasks</span></span>
<span class="line"><span style="color:#FFCB6B;">npx</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">directus</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">database</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span></span>
<span class="line"><span style="color:#FFCB6B;">npx</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">directus</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">database</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">migrate:latest</span></span>
<span class="line"><span style="color:#FFCB6B;">npx</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">directus</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">schema</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">apply</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">./path/to/snapshot.yaml</span></span></code></pre></div><p>Take notice here - to comply with this flow, <code>migrations</code> directory <strong>must not contain</strong> tasks that modify the contents of your Directus, because schema is not yet created when you run <code>migrate:latest</code>.</p>`,16),l=[t];function p(r,c,i,y,D,d){return n(),a("div",null,l)}const C=s(e,[["render",p]]);export{u as __pageData,C as default};
